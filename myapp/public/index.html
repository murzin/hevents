<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>People and Events</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom style for timeline height */
        .event-timeline div {
            height: 10px;
        }
    </style>
</head>
<body onload="main()" class="bg-gradient-to-br from-blue-50 to-gray-100 h-screen w-screen font-sans antialiased">
    <table class="w-full h-full border-collapse">
        <tr>
            <td id="headBlock" colspan="2" class="h-[10%] bg-white shadow-md"></td>
        </tr>
        <tr>
            <td id="menuBlock" class="w-1/5 h-[80%] bg-white shadow-md align-top"></td>
            <td id="workBlock" class="w-4/5 h-[80%] bg-white shadow-md align-top"></td>
        </tr>
        <tr>
            <td id="footerBlock" colspan="2" class="h-[10%] bg-white shadow-md text-center"></td>
        </tr>
    </table>

    <script>
        const API_HOST = 'http://127.0.0.1:3000';
        const API_EVENTS = '/api/events';
        const API_EVENTTYPES = '/api/event_types';
        const API_EVENTPLACES = '/api/event_places';
        let etp_ids = [];
        let epl_ids = [];
        let events = [];

        function main() {
            getEvents();
            document.getElementById('headBlock').innerHTML = Head();
            document.getElementById('menuBlock').innerHTML = Menu();
            document.getElementById('workBlock').innerHTML = Work();
            document.getElementById('footerBlock').innerHTML = Footer();
        }

        function getEvents() {
            if (isFirstTime()) {
                getAllREST();
            } else {
                updatePageTypesPlaces();
                updatePageEvents();
            }
        }

        function getAllREST() {
            getEventsREST();
            getEventTypesREST();
            getEventPlacesREST();
        }

        function getEventsREST() {
            fetch(API_HOST + API_EVENTS, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => storeToDb(data))
            .catch(error => console.error('Error fetching events:', error));
        }

        function getEventTypesREST() {
            fetch(API_HOST + API_EVENTTYPES, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => localStorage.setItem('event_types', JSON.stringify(data)))
            .catch(error => console.error('Error fetching event types:', error));
        }

        function getEventPlacesREST() {
            fetch(API_HOST + API_EVENTPLACES, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => localStorage.setItem('event_places', JSON.stringify(data)))
            .catch(error => console.error('Error fetching event places:', error));
        }
        function storeToDb(eventsArray) {
            const request = indexedDB.open('EventsDB', 1);

            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
            };

            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['events'], 'readwrite');
                const store = transaction.objectStore('events');
                
                store.clear().onsuccess = function() {
                    eventsArray.forEach(event => store.add(event));
                };

                transaction.oncomplete = function() {
                    db.close();
                    updateLSTypesPlaces();
                };
            };
        }

        function updateLSTypesPlaces() {
            const request = indexedDB.open('EventsDB', 1);

            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['events'], 'readonly');
                const store = transaction.objectStore('events');
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = function() {
                    const allEvents = getAllRequest.result;
                    
                    if (!localStorage.getItem('etp_ids')) {
                        const uniqueEtpIds = [...new Set(allEvents.map(event => event.etp_id))];
                        localStorage.setItem('etp_ids', JSON.stringify(uniqueEtpIds));
                    }
                    if (!localStorage.getItem('epl_ids')) {
                        const uniqueEplIds = [...new Set(allEvents.map(event => event.epl_id))];
                        localStorage.setItem('epl_ids', JSON.stringify(uniqueEplIds));
                    }
                    
                    updatePageTypesPlaces();
                    updatePageEvents();
                };
            };
        }

        function updatePageEvents() {
            const request = indexedDB.open('EventsDB', 1);

            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['events'], 'readonly');
                const store = transaction.objectStore('events');
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = function() {
                    const allEvents = getAllRequest.result;
                    events = allEvents.filter(event => 
                        etp_ids.includes(event.etp_id) && 
                        epl_ids.includes(event.epl_id)
                    );
                    db.close();
                    document.getElementById('workBlock').innerHTML = Work();
                };
            };
        }

        function updatePageTypesPlaces() {
            etp_ids = JSON.parse(localStorage.getItem('etp_ids') || '[]');
            epl_ids = JSON.parse(localStorage.getItem('epl_ids') || '[]');
        }

        function isFirstTime() {
            return !(localStorage.getItem('etp_ids') && localStorage.getItem('epl_ids'));
        }

        function createTypesCheckboxes() {
            let html = '<h3 class="text-lg font-medium text-blue-900">Event Types</h3>';
            const eventTypes = JSON.parse(localStorage.getItem('event_types') || '[]');
            
            if (eventTypes.length === 0) {
                html += '<p class="text-gray-500 text-sm">No event types available</p>';
            } else {
                html += '<ul class="mt-2 space-y-3">';
                eventTypes.forEach(type => {
                    const isChecked = etp_ids.includes(type.etp_id) ? 'checked' : '';
                    html += `
                        <li class="flex items-center">
                            <input type="checkbox" id="type_${type.etp_id}" ${isChecked}
                                onchange="toggleEventType('${type.etp_id}', this.checked)"
                                class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="type_${type.etp_id}" class="ml-3 text-gray-700">${type.etp_name || 'Unnamed Type'}</label>
                        </li>
                    `;
                });
                html += '</ul>';
            }
            return html;
        }

        function createPlaceCheckboxes() {
            let html = '<h3 class="text-lg font-medium text-blue-900">Event Places</h3>';
            const eventPlaces = JSON.parse(localStorage.getItem('event_places') || '[]');
            
            if (eventPlaces.length === 0) {
                html += '<p class="text-gray-500 text-sm">No event places available</p>';
            } else {
                html += '<ul class="mt-2 space-y-3">';
                eventPlaces.forEach(place => {
                    const isChecked = epl_ids.includes(place.epl_id) ? 'checked' : '';
                    html += `
                        <li class="flex items-center">
                            <input type="checkbox" id="place_${place.epl_id}" ${isChecked}
                                onchange="toggleEventPlace('${place.epl_id}', this.checked)"
                                class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="place_${place.epl_id}" class="ml-3 text-gray-700">${place.epl_name || 'Unnamed Place'}</label>
                        </li>
                    `;
                });
                html += '</ul>';
            }
            return html;
        }

        function toggleEventType(typeId, isChecked) {
            const numericTypeId = Number(typeId);
            let currentEtpIds = JSON.parse(localStorage.getItem('etp_ids') || '[]');
            
            if (isChecked) {
                if (!currentEtpIds.includes(numericTypeId)) {
                    currentEtpIds.push(numericTypeId);
                    localStorage.setItem('etp_ids', JSON.stringify([...new Set(currentEtpIds)]));
                    updatePageTypesPlaces();
                    updatePageEvents();
                }
            } else {
                currentEtpIds = currentEtpIds.filter(id => id !== numericTypeId);
                localStorage.setItem('etp_ids', JSON.stringify(currentEtpIds));
            }

            const rows = document.querySelectorAll(`.etp_id${numericTypeId}`);
            rows.forEach(row => {
                row.style.display = isChecked ? 'flex' : 'none';
            });
            const timelines = document.querySelectorAll(`.etp_id${numericTypeId}`);
            timelines.forEach(timeline => {
                timeline.style.display = isChecked ? 'flex' : 'none';
            });
        }

        function toggleEventPlace(placeId, isChecked) {
            const numericPlaceId = Number(placeId);
            let currentEplIds = JSON.parse(localStorage.getItem('epl_ids') || '[]');
            
            if (isChecked) {
                if (!currentEplIds.includes(numericPlaceId)) {
                    currentEplIds.push(numericPlaceId);
                    localStorage.setItem('epl_ids', JSON.stringify([...new Set(currentEplIds)]));
                    updatePageTypesPlaces();
                    updatePageEvents();
                }
            } else {
                currentEplIds = currentEplIds.filter(id => id !== numericPlaceId);
                localStorage.setItem('epl_ids', JSON.stringify(currentEplIds));
            }

            const rows = document.querySelectorAll(`.epl_id${numericPlaceId}`);
            rows.forEach(row => {
                row.style.display = isChecked ? 'flex' : 'none';
            });
            const timelines = document.querySelectorAll(`.epl_id${numericPlaceId}`);
            timelines.forEach(timeline => {
                timeline.style.display = isChecked ? 'flex' : 'none';
            });
        }

        function Head() {
            return `
                <h1 class="text-3xl font-bold text-blue-900 text-center py-2 tracking-tight">People and Events</h1>
            `;
        }

        function Menu() {
            return `
                <div class="p-6">
                    <button onclick="getAllREST()" class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">Reload Events</button>
                    <div class="mt-6 grid grid-cols-2 gap-6">
                        <div>${createTypesCheckboxes()}</div>
                        <div>${createPlaceCheckboxes()}</div>
                    </div>
                </div>
            `;
        }

        function Work() {
            let html = '<div class="p-6">';
            if (events.length === 0) {
                html += '<h2 class="text-2xl font-semibold text-blue-900">Events</h2><p class="text-gray-500 mt-2">No events available</p>';
            } else {
                const minFrom = events.reduce((min, event) => event.evt_from < min ? event.evt_from : min, events[0].evt_from);
                const maxTo = events.reduce((max, event) => event.evt_to > max ? event.evt_to : max, events[0].evt_to);
                html += `<h2 class="text-2xl font-semibold text-blue-900">Events from ${minFrom || 'N/A'} to ${maxTo || 'N/A'}</h2>`;
                html += '<div class="mt-4 space-y-6">';
                const totalDuration = new Date(maxTo) - new Date(minFrom);

                events.forEach(event => {
                    const startOffset = new Date(event.evt_from) - new Date(minFrom);
                    const endOffset = new Date(event.evt_to) - new Date(minFrom);
                    const startPercent = (startOffset / totalDuration) * 100;
                    const durationPercent = ((endOffset - startOffset) / totalDuration) * 100;

                    html += `
                        <div class="event-row etp_id${event.etp_id || ''} epl_id${event.epl_id || ''} flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                            <span class="text-gray-800 font-medium">${event.evt_name || 'Unnamed Event'}</span>
                            <span class="text-gray-600 text-sm">From: ${event.evt_from || 'N/A'}</span>
                            <span class="text-gray-600 text-sm">To: ${event.evt_to || 'N/A'}</span>
                        </div>
                        <div class="event-timeline etp_id${event.etp_id || ''} epl_id${event.epl_id || ''} flex w-full bg-gray-200 rounded-full overflow-hidden">
                            <div style="width: ${startPercent}%;"></div>
                            <div style="width: ${durationPercent}%;" class="bg-red-600"></div>
                            <div style="width: ${100 - startPercent - durationPercent}%;"></div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            html += '</div>';
            return html;
        }

        function Footer() {
            return `
                <small class="text-gray-400 text-sm">work in progress..</small>
            `;
        }
    </script>
</body>
</html>
