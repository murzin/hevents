<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Width Layout</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        #headBlock {
            width: 100%;
            height: 20%;
            background-color: #f0f0f0;
        }

        #container {
            width: 100%;
            height: 80%;
            display: flex;
            flex-direction: row;
        }

        #menuBlock {
            width: 20%;
            height: 100%;
            background-color: #e0e0e0;
        }

        #workBlock {
            width: 80%;
            height: 100%;
        }
        .event-row {
            position: relative;
        }
    </style>
</head>
<body onload="main()">
    <div id="headBlock"></div>
    <div id="container">
        <div id="menuBlock"></div>
        <div id="workBlock"></div>
    </div>

    <script>
        const API_HOST = 'http://127.0.0.1:3000';
        const API_EVENTS = '/api/events';
        const API_EVENTTYPES = '/api/event_types';
        const API_EVENTPLACES = '/api/event_places';
        let etp_ids = [];
        let epl_ids = [];
        let events = [];

        function main() {
            getEvents();
            document.getElementById('headBlock').innerHTML = Head();
            document.getElementById('menuBlock').innerHTML = Menu();
            document.getElementById('workBlock').innerHTML = Work();
        }

        function getEvents() {
            if (isFirstTime()) {
                getAllREST();
            } else {
                updatePageTypesPlaces();
                updatePageEvents();
            }
        }

        function getAllREST() {
            getEventsREST();
            getEventTypesREST();
            getEventPlacesREST();
        }

        function getEventsREST() {
            fetch(API_HOST + API_EVENTS, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                storeToDb(data);
            })
            .catch(error => console.error('Error fetching events:', error));
        }

        function getEventTypesREST() {
            fetch(API_HOST + API_EVENTTYPES, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                localStorage.setItem('event_types', JSON.stringify(data));
            })
            .catch(error => console.error('Error fetching event types:', error));
        }

        function getEventPlacesREST() {
            fetch(API_HOST + API_EVENTPLACES, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                localStorage.setItem('event_places', JSON.stringify(data));
            })
            .catch(error => console.error('Error fetching event places:', error));
        }

        function storeToDb(eventsArray) {
            const request = indexedDB.open('EventsDB', 1);

            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
            };

            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['events'], 'readwrite');
                const store = transaction.objectStore('events');
                
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = function() {
                    eventsArray.forEach(event => {
                        store.add(event);
                    });
                };

                transaction.oncomplete = function() {
                    db.close();
                    updateLSTypesPlaces();
                };
            };
        }

        function updateLSTypesPlaces() {
            const request = indexedDB.open('EventsDB', 1);

            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['events'], 'readonly');
                const store = transaction.objectStore('events');
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = function() {
                    const allEvents = getAllRequest.result;
                    
                    if (!localStorage.getItem('etp_ids')) {
                        const uniqueEtpIds = [...new Set(allEvents.map(event => event.etp_id))];
                        localStorage.setItem('etp_ids', JSON.stringify(uniqueEtpIds));
                    }
                    if (!localStorage.getItem('epl_ids')) {
                        const uniqueEplIds = [...new Set(allEvents.map(event => event.epl_id))];
                        localStorage.setItem('epl_ids', JSON.stringify(uniqueEplIds));
                    }
                    
                    updatePageTypesPlaces();
                    updatePageEvents();
                };
            };
        }

        function updatePageEvents() {
            const request = indexedDB.open('EventsDB', 1);

            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['events'], 'readonly');
                const store = transaction.objectStore('events');
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = function() {
                    const allEvents = getAllRequest.result;
                    events = allEvents.filter(event => 
                        etp_ids.includes(event.etp_id) && 
                        epl_ids.includes(event.epl_id)
                    );
                    db.close();
                    // Update the Work block after events are loaded
                    document.getElementById('workBlock').innerHTML = Work();
                };
            };
        }

        function updatePageTypesPlaces() {
            etp_ids = JSON.parse(localStorage.getItem('etp_ids') || '[]');
            epl_ids = JSON.parse(localStorage.getItem('epl_ids') || '[]');
        }

        function isFirstTime() {
            if (localStorage.getItem('etp_ids') && localStorage.getItem('epl_ids')) {
                return false;
            }
            return true;
        }

        function Head() {
            return `
                <h1>Header Area</h1>
                <p>This is the head block taking 20% of window height</p>
            `;
        }

        function Menu() {
            return `
                <button onclick="getAllREST()">Reload Events</button>
            `;
        }

    function Work() {
    let html = '';
    if (events.length === 0) {
        html = '<h2>Events</h2><p>No events available</p>';
    } else {
        const minFrom = events.reduce((min, event) => event.evt_from < min ? event.evt_from : min, events[0].evt_from);
        const maxTo = events.reduce((max, event) => event.evt_to > max ? event.evt_to : max, events[0].evt_to);
        html = `<h2>Events from ${minFrom || 'N/A'} to ${maxTo || 'N/A'}</h2>`;
        html += '<div>';

        // Calculate total duration in milliseconds (assuming evt_from and evt_to are ISO strings or comparable)
        const totalDuration = new Date(maxTo) - new Date(minFrom);

        events.forEach(event => {
            const startOffset = new Date(event.evt_from) - new Date(minFrom);
            const endOffset = new Date(event.evt_to) - new Date(minFrom);
            const startPercent = Math.floor((startOffset / totalDuration) * 100);
            const durationPercent = Math.floor(((endOffset - startOffset) / totalDuration) * 100);

            html += `
                <div class="event-row">
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(to right,
                            transparent ${startPercent}%,
                            #add8e6 ${startPercent}%, #add8e6 ${startPercent + durationPercent}%,
                            transparent ${startPercent + durationPercent}%
                            );
                        z-index: -1;
                    "></div>
                    ${event.evt_name || 'Unnamed Event'}&nbsp;&nbsp;
                    ${event.evt_from || 'N/A'}&nbsp;-&nbsp;${event.evt_to || 'N/A'}
                </div>
            `;
        });
        html += '</div>';
    }
    return html;
}
    </script>
</body>
</html>
